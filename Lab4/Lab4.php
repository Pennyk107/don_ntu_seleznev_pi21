<?php
session_start();

if (isset($_GET['restart']) && $_GET['restart'] === '1') {
  session_destroy();
  session_start();
  $_SESSION['step'] = 1;
  header('Location: ' . $_SERVER['PHP_SELF']);
  exit;
}

// Шаг 1: Создание HTML-документа с формой
if (!isset($_SESSION['step']) || $_SESSION['step'] === 1) {
    echo '
    <!DOCTYPE html>
    <html>
    <head>
  <title>Тест по линейной алгебре</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f2f2f2;
    }

    h2 {
      text-align: center;
      color: #333;
    }

    form {
      max-width: 500px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
    }

    input[type="text"],
    input[type="radio"] {
      margin-bottom: 10px;
    }

    p {
      font-weight: bold;
    }

    input[type="submit"] {
      background-color: #333;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }

    input[type="submit"]:hover {
      background-color: #555;
    }
  </style>
</head>
    <body>
      <h2>Тест по линейной алгебре</h2>
    
      <form action="" method="POST">

        <label for="fullname">ФИО:</label>
        <input type="text" id="fullname" name="fullname" required><br><br>

        <p>Вопрос 1: Что такое матрица?</p>
        <input type="radio" name="Что%20такое%20матрица?" value="a) Скалярное значение"> a) Скалярное значение<br>
        <input type="radio" name="Что%20такое%20матрица?" value="b) Вектор"> b) Вектор<br>
        <input type="radio" name="Что%20такое%20матрица?" value="c) Таблица чисел, упорядоченных в виде прямоугольной сетки"> c) Таблица чисел, упорядоченных в виде прямоугольной сетки<br>
        <input type="radio" name="Что%20такое%20матрица?" value="d) Рациональное число"> d) Рациональное число<br>

        <p>Вопрос 2: Что такое определитель матрицы?</p>
        <input type="radio" name="Что%20такое%20определитель%20матрицы?" value="a) Сумма элементов матрицы"> a) Сумма элементов матрицы<br>
        <input type="radio" name="Что%20такое%20определитель%20матрицы?" value="b) Разность элементов матрицы"> b) Разность элементов матрицы<br>
        <input type="radio" name="Что%20такое%20определитель%20матрицы?" value="c) Произведение элементов матрицы"> c) Произведение элементов матрицы<br>
        <input type="radio" name="Что%20такое%20определитель%20матрицы?" value="d) Число, связанное с матрицей и используемое для решения системы линейных уравнений"> d) Число, связанное с матрицей и используемое для решения системы линейных уравнений<br>

        <p>Вопрос 3: Что такое скалярное произведение двух векторов?</p>
        <input type="radio" name="Что%20такое%20скалярное%20произведение%20двух%20векторов?" value="a) Сумма элементов векторов"> a) Сумма элементов векторов<br>
        <input type="radio" name="Что%20такое%20скалярное%20произведение%20двух%20векторов?" value="b) Произведение элементов векторов"> b) Произведение элементов векторов<br>
        <input type="radio" name="Что%20такое%20скалярное%20произведение%20двух%20векторов?" value="c) Сумма произведений соответствующих элементов векторов"> c) Сумма произведений соответствующих элементов векторов<br>
        <input type="radio" name="Что%20такое%20скалярное%20произведение%20двух%20векторов?" value="d) РРазность элементов векторов"> d) Разность элементов векторов<br>

        <p>Вопрос 4: Что такое собственный вектор матрицы?</p>
        <input type="radio" name="Что%20такое%20собственный%20вектор%20матрицы?" value="a) Вектор, умноженный на скаляр"> a) Вектор, умноженный на скаляр<br>
        <input type="radio" name="Что%20такое%20собственный%20вектор%20матрицы?" value="b) Вектор, не изменяющийся при умножении на матрицу"> b) Вектор, не изменяющийся при умножении на матрицу<br>
        <input type="radio" name="Что%20такое%20собственный%20вектор%20матрицы?" value="c) Вектор, равный нулю"> c) Вектор, равный нулю<br>
        <input type="radio" name="Что%20такое%20собственный%20вектор%20матрицы?" value="d) Вектор, полученный путем сложения других векторов"> d) Вектор, полученный путем сложения других векторов<br>

        <p>Вопрос 5: Что такое ранг матрицы?</p>
        <input type="radio" name="Что%20такое%20ранг%20матрицы?" value="a) Сумма элементов матрицы"> a) Сумма элементов матрицы<br>
        <input type="radio" name="Что%20такое%20ранг%20матрицы?" value="b) Максимальное количество линейно независимых строк (столбцов) матрицы"> b) Максимальное количество линейно независимых строк (столбцов) матрицы<br>
        <input type="radio" name="Что%20такое%20ранг%20матрицы?" value="c) Произведение элементов матрицы"> c) Произведение элементов матрицы<br>
        <input type="radio" name="Что%20такое%20ранг%20матрицы?" value="d) Число, связанное с матрицей и используемое для решения системы линейных уравнений"> d) Число, связанное с матрицей и используемое для решения системы линейных уравнений<br>

        <p>Вопрос 6: Что такое обратная матрица?</p>
        <input type="radio" name="Что%20такое%20обратная%20матрица?" value="a) Матрица, умноженная на скаляр"> a) Матрица, умноженная на скаляр<br>
        <input type="radio" name="Что%20такое%20обратная%20матрица?" value="b) Матрица, не изменяющаяся при умножении на другую матрицу"> b) Матрица, не изменяющаяся при умножении на другую матрицу<br>
        <input type="radio" name="Что%20такое%20обратная%20матрица?" value="c) Матрица, равная нулю"> c) Матрица, равная нулю<br>
        <input type="radio" name="Что%20такое%20обратная%20матрица?" value="d) Матрица, умножаемая на исходную матрицу и дающая единичную матрицу"> d) Матрица, умножаемая на исходную матрицу и дающая единичную матрицу<br>

        <p>Вопрос 7: Какая операция выполняется при умножении матриц?</p>
        <input type="radio" name="Какая%20операция%20выполняется%20при%20умножении%20матриц?" value="a) Сложение элементов матриц"> a) Сложение элементов матриц<br>
        <input type="radio" name="Какая%20операция%20выполняется%20при%20умножении%20матриц?" value="b) Умножение соответствующих элементов матриц"> b) Умножение соответствующих элементов матриц<br>
        <input type="radio" name="Какая%20операция%20выполняется%20при%20умножении%20матриц?" value="c) Умножение строк первой матрицы на столбцы второй матрицы"> c) Умножение строк первой матрицы на столбцы второй матрицы<br>
        <input type="radio" name="Какая%20операция%20выполняется%20при%20умножении%20матриц?" value="d) Вычитание элементов матриц"> d) Вычитание элементов матриц<br>

        <p>Вопрос 8: Что такое сингулярное разложение матрицы?</p>
        <input type="radio" name="Что%20такое%20сингулярное%20разложение%20матрицы?" value="a) Разложение матрицы на сумму двух матриц"> a) Разложение матрицы на сумму двух матриц<br>
        <input type="radio" name="Что%20такое%20сингулярное%20разложение%20матрицы?" value="b) Разложение матрицы на произведение трех матриц"> b) Разложение матрицы на произведение трех матриц<br>
        <input type="radio" name="Что%20такое%20сингулярное%20разложение%20матрицы?" value="c) Разложение матрицы на сумму трех матриц"> c) Разложение матрицы на сумму трех матриц<br>
        <input type="radio" name="Что%20такое%20сингулярное%20разложение%20матрицы?" value="d) Разложение матрицы на произведение двух матриц"> d) Разложение матрицы на произведение двух матриц<br>

        <p>Вопрос 9: Что такое ортогональная матрица?</p>
        <input type="radio" name="Что%20такое%20ортогональная%20матрица?" value="a) Матрица, умножаемая на исходную матрицу и дающая единичную матрицу"> a) Матрица, умножаемая на исходную матрицу и дающая единичную матрицу<br>
        <input type="radio" name="Что%20такое%20ортогональная%20матрица?" value="b) Матрица, не изменяющаяся при умножении на другую матрицу"> b) Матрица, не изменяющаяся при умножении на другую матрицу<br>
        <input type="radio" name="Что%20такое%20ортогональная%20матрица?" value="c) Матрица, умноженная на скаляр"> c) Матрица, умноженная на скаляр<br>
        <input type="radio" name="Что%20такое%20ортогональная%20матрица?" value="d) Матрица, у которой строки (столбцы) образуют ортонормированную систему"> d) Матрица, у которой строки (столбцы) образуют ортонормированную систему<br>

        <p>Вопрос 10: Что такое линейное пространство?</p>
        <input type="radio" name="Что%20такое%20линейное%20пространство?" value="a) Множество всех возможных матриц"> a) Множество всех возможных матриц<br>
        <input type="radio" name="Что%20такое%20линейное%20пространство?" value="b) Множество всех возможных векторов"> b) Множество всех возможных векторов<br>
        <input type="radio" name="Что%20такое%20линейное%20пространство?" value="c) Множество всех возможных скалярных значений"> c) Множество всех возможных скалярных значений<br>
        <input type="radio" name="Что%20такое%20линейное%20пространство?" value="d) Множество всех возможных скаляров"> d) Множество всех возможных скаляров<br>
        
            
        <br>
        <input type="submit" name="submit" value="Отправить">
      </form>
    </body>
    </html>
    ';

    $_SESSION['step'] = 2;
}

// Шаг 2: Обработка формы и сохранение результатов
if (isset($_POST['submit']) && $_SESSION['step'] === 2) {
    $answers = array(
        "Что%20такое%20матрица?" => $_POST["Что%20такое%20матрица?"],
        "Что%20такое%20определитель%20матрицы?" => $_POST["Что%20такое%20определитель%20матрицы?"],
        "Что%20такое%20скалярное%20произведение%20двух%20векторов?" => $_POST["Что%20такое%20скалярное%20произведение%20двух%20векторов?"],
        "Что%20такое%20собственный%20вектор%20матрицы?" => $_POST["Что%20такое%20собственный%20вектор%20матрицы?"],
        "Что%20такое%20ранг%20матрицы?" => $_POST["Что%20такое%20ранг%20матрицы?"],
        "Что%20такое%20обратная%20матрица?" => $_POST["Что%20такое%20обратная%20матрица?"],
        "Какая%20операция%20выполняется%20при%20умножении%20матриц?" => $_POST["Какая%20операция%20выполняется%20при%20умножении%20матриц?"],
        "Что%20такое%20сингулярное%20разложение%20матрицы?" => $_POST["Что%20такое%20сингулярное%20разложение%20матрицы?"],
        "Что%20такое%20ортогональная%20матрица?" => $_POST["Что%20такое%20ортогональная%20матрица?"],
        "Что%20такое%20линейное%20пространство?" => $_POST["Что%20такое%20линейное%20пространство?"]

    );
  
    $correctAnswers = array(
        'Что%20такое%20матрица?' => "c) Таблица чисел, упорядоченных в виде прямоугольной сетки",
        'Что%20такое%20определитель%20матрицы?' => "d) Число, связанное с матрицей и используемое для решения",
        'Что%20такое%20скалярное%20произведение%20двух%20векторов?' => "c) Сумма произведений соответствующих элементов векторов",
        'Что%20такое%20собственный%20вектор%20матрицы?' => "b) Вектор, не изменяющийся при умножении на матрицу",
        'Что%20такое%20ранг%20матрицы?' => "b) Максимальное количество линейно независимых строк",
        'Что%20такое%20обратная%20матрица?' => "d) Матрица, умножаемая на исходную матрицу и дающая единичную матрицу",
        'Какая%20операция%20выполняется%20при%20умножении%20матриц?' => "c) Умножение строк первой матрицы на столбцы второй матрицы",
        'Что%20такое%20сингулярное%20разложение%20матрицы?' => "b) Разложение матрицы на произведение трех матриц",
        'Что%20такое%20ортогональная%20матрица?' => "d) Матрица, у которой строки (столбцы) образуют ортонормированную систему",
        'Что%20такое%20линейное%20пространство?' => "b) Множество всех возможных векторов",

    );

    $fullName = $_POST['fullname']; // Замените на данные пользователя

    $filename = $fullName . '.txt';
    $fileContent = "ФИО: $fullName\n";
    $fileContent .= "Дата и время: " . date('Y-m-d H:i:s') . "\n\n";
  
    foreach ($answers as $question => $answer) {
        $questionCor = str_replace("%20", " ", $question);
        $fileContent .= "Вопрос: $questionCor\n";
        $fileContent .= "Ответ: $answer\n";
        $fileContent .= "Правильно: " . ($answer === $correctAnswers[$question]? 'Да' : 'Нет') . "\n\n";
    }

    file_put_contents($filename, $fileContent);

    $_SESSION['step'] = 3;

    // Шаг 3: Отображение результатов
    echo '
<!DOCTYPE html>
<html>
<head>
<title>Результаты теста по линейной алгебре</title>
<style>
body {
  font-family: Arial, sans-serif;
  background-color: #f2f2f2;
  margin: 0;
  padding: 20px;
}

h2 {
  color: #333;
  text-align: center;
}

p {
  margin: 0;
  padding: 5px 0;
}

h3 {
  color: #555;
}

.question {
  font-weight: bold;
}

.answer {
  margin-left: 20px;
}

.correct-answer {
  color: green;
}

.incorrect-answer {
  color: red;
}

.restart-link {
  display: block;
  margin-top: 20px;
  text-align: center;
  text-decoration: none;
  color: #fff;
  background-color: #007bff;
  padding: 10px 20px;
  border-radius: 5px;
}

.restart-link:hover {
  background-color: #0056b3;
}

.result-link {
  display: block;
  margin-top: 20px;
  text-align: center;
  text-decoration: none;
  color: #fff;
  background-color: #007bff;
  padding: 10px 20px;
  border-radius: 5px;
}

.result-link:hover {
  background-color: #0056b3;
}
</style>
</head>
<body>
<h2>Результаты теста</h2>
<p>ФИО: ' . $fullName . '</p>
<p>Дата и время: ' . date('Y-m-d H:i:s') . '</p>
<h3>Ответы:</h3>
';

foreach ($answers as $question => $answer) {
  $questionCor = str_replace("%20", " ", $question);
  echo "<p class='question'>Вопрос: $questionCor</p>";
  echo "<p class='answer'>Ответ: $answer</p>";
  echo "<p class='" . ($answer === $correctAnswers[$question] ? 'correct-answer' : 'incorrect-answer') . "'>Правильно: " . ($answer === $correctAnswers[$question] ? 'Да' : 'Нет') . "</p>";

  if ($answer !== $correctAnswers[$question]) {
    echo "<p class='correct-answer'>Правильный ответ: " . $correctAnswers[$question] . "</p>";
  }

  echo "<hr>";
}

echo '<p><a href="' . $_SERVER['PHP_SELF'] . '?restart=1" class="restart-link">Пройти тест ещё раз</a></p>';
echo '<a href="results.zip" class="result-link">Скачать все результаты</a>';
echo '

</body>
</html>
';
}

// Шаг 4: Упаковка результатов в zip-архив
if (isset($_SESSION['step']) && $_SESSION['step'] === 3) {
  $zip = new ZipArchive();
  $zipFilename = 'results.zip';

  if ($zip->open($zipFilename, ZipArchive::CREATE) === true) {
      $zip->addFile($filename, $filename);
      $zip->close();
  }
}

// Шаг 5: Создание HTML-документа со списком результатов
if (!empty($_GET['show_results'])) {
    $zipFilename = 'results.zip';

    if (file_exists($zipFilename)) {
        $zip = new ZipArchive();
        if ($zip->open($zipFilename) === true) {
            echo '
            <!DOCTYPE html>
            <html>
            <head>
              <title>Список результатов</title>
            </head>
            <body>
              <h2>Список результатов</h2>
            ';

            for ($i = 0; $i < $zip->numFiles; $i++) {
                $filename = $zip->getNameIndex($i);
                echo '<a href="?download=' . urlencode($filename) . '">' . $filename . '</a><br>';
            }

            echo '
            </body>
            </html>
            ';

            $zip->close();
        }
    }
}

// Шаг 6: Загрузка файла с результатами
if (!empty($_GET['download'])) {
    $zipFilename = 'results.zip';
    $filename = $_GET['download'];

    if (file_exists($zipFilename)) {
        $zip = new ZipArchive();
        if ($zip->open($zipFilename) === true) {
            $fileContent = $zip->getFromName($filename);

            header('Content-Type: text/plain');
            header('Content-Disposition: attachment; filename="' . $filename . '"');

            echo $fileContent;
        }
    }
}
?>